#!/usr/bin/env bash

SCRIPTPATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 || exit ; pwd -P )"

function token {
  local environment=${1:-local}
  
  local baseUrl
  
  source "${SCRIPTPATH}/.env.local"
  
  local phone=${LIANE_AUTH__TESTACCOUNT:-0000111111}
  local code=${LIANE_AUTH__TESTCODE:-333333}
  
  if [[ "${environment}" = "local" ]]; then
    baseUrl="http://localhost:5000"
    phone=0000111111
    code=333333
  elif [[ "${environment}" = "dev" ]]; then
    baseUrl="https://dev.liane.app"
  elif [[ "${environment}" = "prod" ]]; then
    baseUrl="https://liane.app"
  fi;
  
  local effectivePhone=${2:-${phone}}
  local effectiveCode=${3:-${code}}
  
  local token
  token=$(http "${baseUrl}/api/auth/login" "phone=${effectivePhone}" "code=${effectiveCode}" | jq -r .token.accessToken)
  echo "Authorization:Bearer${token}"
}

function dump_on_local {
  local environment=${1:-dev}
    
  local suffix="-dev"
  
  if [[ "${environment}" = "prod" ]]; then
    suffix=""
  fi;
  
  ssh gjini.co "/home/ubuntu/liane${suffix}/deploy/liane dump" | docker exec -i mongo mongorestore --archive --gzip -u mongoadmin -p secret
}

function mongo_start {
    mongo_stop
    docker run -d --name mongo \
        -e MONGO_INITDB_ROOT_USERNAME=mongoadmin \
        -e MONGO_INITDB_ROOT_PASSWORD=secret \
        -p 27017:27017 \
        -v "${SCRIPTPATH}/data/mongo:/data/db" \
        --restart unless-stopped mongo:4.4.4
}

function mongo_stop {
    docker rm -f mongo 2> /dev/null
}

function mongo_purge {
    mongo_stop
    sudo rm -Rf "${SCRIPTPATH}/data/mongo"
    mongo_start
}

function martin_start {
    martin_stop
    docker run -d --name martin -p 3000:3000 --link postgis:postgis -e "DATABASE_URL=postgresql://postgis:secret@postgis/liane" ghcr.io/maplibre/martin
}

function martin_stop {
    docker rm -f martin 2> /dev/null
}

function postgis_start {
    postgis_stop
    docker run -d --name postgis -p 5432:5432 -e POSTGRES_DB=liane -e POSTGRES_USER=postgis -e POSTGRES_PASSWORD=secret -v "${SCRIPTPATH}/../deploy/postgis/init.sql:/docker-entrypoint-initdb.d/init.sql:ro" postgis/postgis:15-3.3
}

function postgis_stop {
    docker rm -f postgis 2> /dev/null
}

function postgis_purge {
    postgis_stop
    sudo rm -Rf "${SCRIPTPATH}/data/postgis"
    postgis_start
}

function stop {
  mongo_stop
  postgis_stop
}

function start {
  dotnet run --project "${SCRIPTPATH}/src/Liane/Liane.Web/Liane.Web.csproj"
}

function init {
  mongo_purge
  postgis_purge
  sleep 2
  martin_start
}

case "$1" in
 stop)
  stop
  ;;
 token)
  token ${@:2}
  ;;
 start)
  start
  ;;
 init)
  init
  ;;
 dump_on_local)
  dump_on_local ${@:2}
  ;;
 *)
  # else
  echo "Usage: liane (token|init|start|stop|dump_on_local)"
  ;;
esac
